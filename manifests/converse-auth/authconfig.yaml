apiVersion: authorino.kuadrant.io/v1beta3
kind: AuthConfig
metadata:
  name: converse-api-protection
  namespace: converse-llm
spec:
  hosts:
    - "api.ai.camer.digital"
  
  # Identity phase is still required by Authorino, but since we rely on 
  # the custom REST API for both AuthN and AuthZ, we set identity to anonymous.
  authentication:
    "anonymous-identity":
      anonymous: {}
  
  # Fetch data from the external REST API (this acts as AuthN + AuthZ combined)
  # If this endpoint returns a non-200 status, Authorino rejects the request.
  metadata:
    "lightbridge-validation":
      http:
        url: https://lightbridge-opa.converse-lightbridge.svc.cluster.local:3000/v1/authorino/validate
        method: POST
        headers:
          "Content-Type":
            value: "application/json"
        # We use 'selector' to construct the JSON payload dynamically.
        # The @extract modifier removes 'Bearer ' from the Authorization header.
        body:
          selector: >
            {"api_key": "{context.request.http.headers.authorization.@extract:{\"sep\":\" \",\"pos\":1}}", "ip": "{context.request.http.headers.x-forwarded-for}"}

  # Enforce that the API Key was actually validated and belongs to a project
  authorization:
    "enforce-valid-key":
      patternMatching:
        rules:
          - selector: "auth.metadata.lightbridge-validation.project.id"
            operator: "neq"
            value: ""

  response:
    success:
      # Inject dynamic metadata to Envoy for OpenTelemetry logs
      dynamicMetadata:
        "llm_project_id":
          plain:
            selector: "auth.metadata.lightbridge-validation.project.id"
        "llm_account_id":
          plain:
            selector: "auth.metadata.lightbridge-validation.account.id"
        "llm_api_key_id":
          plain:
            selector: "auth.metadata.lightbridge-validation.api_key.id"
      # Inject headers downstream to your LLM or AI Gateway
      headers:
        "x-project-id":
          plain:
            selector: "auth.metadata.lightbridge-validation.project.id"
        "x-account-id":
          plain:
            selector: "auth.metadata.lightbridge-validation.account.id"
