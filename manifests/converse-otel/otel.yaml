apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: converse
  namespace: converse-otel
spec:
  # mode: deployment  # optional; defaults to deployment in most setups
  env:
    - name: PHOENIX_API_KEY
      valueFrom:
        secretKeyRef:
          name: pheonix-otel-key
          key: PHOENIX_API_KEY

  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      memory_limiter:
        check_interval: 1s
        limit_percentage: 75
        spike_limit_percentage: 15
      batch: {}

    exporters:
      # Phoenix HTTP ingest endpoint:
      # - If Phoenix is inside the cluster, keep http://
      otlphttp/phoenix:
        endpoint: "http://phoenix.converse.svc.cluster.local:6006"
        headers:
          # Phoenix docs: Bearer auth; lowercase header for compatibility.
          authorization: "Bearer ${env:PHOENIX_API_KEY}"

      debug:
        verbosity: normal

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlphttp/phoenix, debug]