applications:

  - name: redis
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: base-apps
    source:
      repoURL: registry-1.docker.io/bitnamicharts
      targetRevision: 24.0.0
      chart: redis
      helm:
        releaseName: redis
        valuesObject:
          global:
            defaultStorageClass: linode-block-storage
          auth:
            enabled: false
          image:
            repository: bitnamilegacy/redis
          architecture: replication
          replica:
            replicaCount: 1
    destination:
      namespace: redis-system
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: eg
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://docker.io/envoyproxy/gateway-helm
      targetRevision: v1.7.0
      path: .
      helm:
        releaseName: eg
        valuesObject:
          hpa:
            enabled: true
            minReplicas: 1
            maxReplicas: 2
          config:
            envoyGateway:
              gateway:
                controllerName: gateway.envoyproxy.io/gatewayclass-controller
              logging:
                level:
                  default: info
              rateLimit:
                backend:
                  type: Redis
                  redis:
                    # Update this URL to match your Redis service location
                    # This assumes Redis is deployed using the redis.yaml in this directory
                    url: redis-master.redis-system.svc.cluster.local:6379
              provider:
                type: Kubernetes
                kubernetes:
                  rateLimitDeployment:
                    patch:
                      type: StrategicMerge
                      value:
                        spec:
                          template:
                            spec:
                              containers:
                                - imagePullPolicy: IfNotPresent
                                  name: envoy-ratelimit
                                  image: docker.io/envoyproxy/ratelimit:60d8e81b
              extensionApis:
                # Not strictly required, but recommended for backward/future compatibility.
                enableEnvoyPatchPolicy: true
                # Required: Enable Backend API for AI service backends.
                enableBackend: true
              # Required: AI Gateway needs to fine-tune xDS resources generated by Envoy Gateway.
              extensionManager:
                #backendResources:
                #  - group: inference.networking.k8s.io
                #    kind: InferencePool
                #    version: v1
                hooks:
                  xdsTranslator:
                    translation:
                      listener:
                        includeAll: true
                      route:
                        includeAll: true
                      cluster:
                        includeAll: true
                      secret:
                        includeAll: true
                    post:
                      - Translation
                      - Cluster
                      - Route
                service:
                  fqdn:
                    # IMPORTANT: Update this to match your AI Gateway controller service
                    # Format: <service-name>.<namespace>.svc.cluster.local
                    # Default if you followed the installation steps above:
                    hostname: ai-gateway-controller.envoy-ai-gateway-system.svc.cluster.local
                    port: 1063
    destination:
      namespace: envoy-gateway-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: aieg-crd
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://docker.io/envoyproxy/ai-gateway-crds-helm
      targetRevision: v0.5.0
      path: .
      helm:
        releaseName: aieg-crd
    destination:
      namespace: envoy-ai-gateway-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: aieg
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://docker.io/envoyproxy/ai-gateway-helm
      targetRevision: v0.5.0
      path: .
      helm:
        releaseName: aieg
        valuesObject:
          controller:
            mutatingWebhook:
              certManager:
                enable: true
                # The name of the issuer.
                issuerName: self-signed-ca
                # The name of the certificate.
                certificateName: self-signed-cert-for-mutating-webhook-managed
          extProc:
            extraEnvVars:
                - name: OTEL_EXPORTER_OTLP_ENDPOINT
                  value: "http://converse-collector.converse-otel:4317"
                - name: OTEL_METRICS_EXPORTER
                  value: "none"
                - name: LOG_LEVEL
                  value: "debug"
    destination:
      namespace: envoy-ai-gateway-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: phoenix
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: oci://registry-1.docker.io/arizephoenix/phoenix-helm
      targetRevision: 4.0.36
      path: .
      helm:
        releaseName: phoenix
        valuesObject:
          persistence:
            storageClass: linode-block-storage
          service:
            type: "ClusterIP"
          ingress:
            host: "analytics.ai.camer.digital"
            annotations:
              cert-manager.io/cluster-issuer: cert-home-cert-http
            tls:
              enabled: true
          additionalEnv:
            - name: PHOENIX_OAUTH2_KEYCLOAK_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: converse-phoenix-keycloak
                  key: client_secret
          auth:
            disableBasicAuth: true
            useSecureCookies: true
            createSecret: false
            name: "converse-phoenix"
            oauth2:
              enabled: true
              providers:
                keycloak:
                  client_id: "phoenix"
                  #client_secret: "your-keycloak-client-secret"
                  oidc_config_url: "https://accounts.ssegning.com/realms/camer-digital/.well-known/openid-configuration"
                  display_name: "CDigital"
                  allow_sign_up: true
                  auto_login: true
                  # Advanced: Extract roles from nested Keycloak structure
                  #groups_attribute_path: "resource_access.phoenix.roles"
                  #allowed_groups: ["admin", "developer", "viewer"]
                  # Advanced: Role mapping - map IDP roles to Phoenix roles (ADMIN, MEMBER, VIEWER)
                  role_attribute_path: "phoenix_role"  # JMESPath to extract role
                  role_mapping: "admin:ADMIN,user:MEMBER,viewer:VIEWER"  # Map IDP roles to Phoenix roles
                  role_attribute_strict: true  # If true, deny access when role cannot be determined
                  use_pkce: true
                  scopes: "openid phoenix"

    destination:
      namespace: converse-phoenix
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: authorino-operator
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    project: ai
    source:
      repoURL: https://kuadrant.io/helm-charts
      targetRevision: 0.22.0
      chart: authorino-operator
      helm:
        releaseName: authorino-operator
    destination:
      namespace: authorino-system
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: secrets
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/ai-ops-secrets.git
      targetRevision: HEAD
      path: manifests
    destination:
      namespace: manifests
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-auth
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/converse-ops
      targetRevision: HEAD
      path: manifests/converse-auth
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-mcp
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/converse-ops
      targetRevision: HEAD
      path: manifests/converse-mcp
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-otel
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/converse-ops
      targetRevision: HEAD
      path: manifests/converse-otel
    destination:
      namespace: converse-otel
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-deps
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/converse-ops
      targetRevision: HEAD
      path: manifests/converse-deps
    destination:
      namespace: converse-deps
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-llm-core
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/ai-helm
      targetRevision: feat/observability
      path: charts/ai-gateway-core
      helm:
        releaseName: converse-core
        valuesObject:
          envoy:
            namespace: "converse-llm"
          tls:
            enabled: true
            domains:
              - converse-llm.camer.digital
              - api.ai.camer.digital
            secretName: converse-llm-tls
            issuer:
              create: false
              kind: ClusterIssuer
              name: cert-home-cert-http
            redirectToHttps: true
          envoyProxy:
#            logging:
#              level:
#                default: debug
            provider:
              type: Kubernetes
              kubernetes:
                envoyDeployment:
                  replicas: 2
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-llm-models
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/ai-helm
      targetRevision: HEAD
      path: charts/models
      helm:
        releaseName: converse-models
        valuesObject: { }
    destination:
      namespace: converse-llm
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-chat
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/converse-ops
      targetRevision: HEAD
      path: charts/converse
      helm:
        releaseName: converse
        valuesObject: { }
    destination:
      namespace: converse-chat
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: lightbridge
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://adorsys-gis.github.io/lightbridge-authz
      targetRevision: 0.5.6
      chart: lightbridge
      helm:
        releaseName: lightbridge
        valuesObject:
          global:
            authz:
              image:
                version: "sha-0ad64f8e85fa5ee40310b40057a3e04c155c1e4e"
            authz_usage:
              image:
                version: "sha-0ad64f8e85fa5ee40310b40057a3e04c155c1e4e"
            tls:
              enabled: false

          api:
            enabled: true
            configMaps:
              config:
                enabled: true
                data:
                  config.yaml: |
                    logging:
                      level: info
                    database:
                      url: "${DATABASE_URL}"
                      pool_size: 10
                    oauth2:
                      jwks_url: http://keycloak:9100/realms/dev/protocol/openid-connect/certs
                    server:
                      api:
                        address: 0.0.0.0
                        port: 3000
                        tls:
                          cert_path: /etc/lightbridge/tls/tls.crt
                          key_path: /etc/lightbridge/tls/tls.key
                      opa:
                        address: 0.0.0.0
                        port: 3000
                        tls:
                          cert_path: /etc/lightbridge/tls/tls.crt
                          key_path: /etc/lightbridge/tls/tls.key
                        basic_auth:
                          username: authorino
                          password: "${OPA_PASSWORD}"
                    otel:
                      enabled: false
                      otlp_endpoint: "http://localhost:4317"
                      service_name: "lightbridge-authz"
            controllers:
              main:
                replicas: 2
                containers:
                  authz:
                    env:
                      DATABASE_URL:
                        valueFrom:
                          secretKeyRef:
                            name: lightbridge-main-app
                            key: uri
              migrate:
                containers:
                  authz:
                    env:
                      DATABASE_URL:
                        valueFrom:
                          secretKeyRef:
                            name: lightbridge-main-app
                            key: uri
            persistence:
              tls:
                name: authz-tls

          opa:
            enabled: false
            configMaps:
              config:
                enabled: true
                data:
                  config.yaml: |
                    logging:
                      level: info
                    database:
                      url: "${DATABASE_URL}"
                      pool_size: 10
                    oauth2:
                      jwks_url: http://keycloak:9100/realms/dev/protocol/openid-connect/certs
                    server:
                      api:
                        address: 0.0.0.0
                        port: 3000
                        tls:
                          cert_path: /etc/lightbridge/tls/tls.crt
                          key_path: /etc/lightbridge/tls/tls.key
                      opa:
                        address: 0.0.0.0
                        port: 3000
                        tls:
                          cert_path: /etc/lightbridge/tls/tls.crt
                          key_path: /etc/lightbridge/tls/tls.key
                        basic_auth:
                          username: authorino
                          password: "${OPA_PASSWORD}"
                    otel:
                      enabled: false
                      otlp_endpoint: "http://localhost:4317"
                      service_name: "lightbridge-authz"
            controllers:
              main:
                replicas: 1
            persistence:
              tls:
                name: authz-tls

          usage:
            enabled: false
            persistence:
              tls:
                name: authz-tls
          rawRessources:
            - |
              apiVersion: cert-manager.io/v1
              kind: Certificate
              metadata:
                name: authz-tls
                namespace: converse-lightbridge
              spec:
                secretName: authz-tls
                issuerRef:
                  name: self-signed-ca
                  kind: ClusterIssuer
                commonName: lightbridge-api.converse-lightbridge.svc.cluster.local
                dnsNames:
                  - lightbridge-api.converse-lightbridge.svc.cluster.local
                  - lightbridge-opa.converse-lightbridge.svc.cluster.local
                  - lightbridge-api.converse-lightbridge.svc.cluster
                  - lightbridge-opa.converse-lightbridge.svc.cluster
                  - lightbridge-api.converse-lightbridge.svc
                  - lightbridge-opa.converse-lightbridge.svc
                  - lightbridge-api.converse-lightbridge
                  - lightbridge-opa.converse-lightbridge
                usages:
                  - server auth
                  - client auth
            - |
              apiVersion: postgresql.cnpg.io/v1
              kind: Cluster
              metadata:
                name: lightbridge-main
                namespace: converse-lightbridge
              spec:
                instances: 2
                storage:
                  storageClass: linode-block-storage
                  size: "5Gi"
                resources:
                  limits:
                    cpu: 300m
                    memory: 1Gi
                  requests:
                    cpu: 200m
                    memory: 500Mi
            - |
              ---
              apiVersion: postgresql.cnpg.io/v1
              kind: ClusterImageCatalog
              metadata:
                name: lightbridge-usage
                namespace: converse-lightbridge
              spec:
                images:
                  - major: 17
                    image: timescale/timescaledb:2.21.1-pg17
              ---
              apiVersion: postgresql.cnpg.io/v1
              kind: Cluster
              metadata:
                name: lightbridge-usage
                namespace: converse-lightbridge
              spec:
                instances: 2
                #imageName: ghcr.io/clevyr/cloudnativepg-timescale:17-ts2
                imageCatalogRef:
                  apiGroup: postgresql.cnpg.io
                  kind: ClusterImageCatalog
                  name: lightbridge-usage
                  major: 17
                storage:
                  storageClass: linode-block-storage
                  size: "10Gi"
                resources:
                  limits:
                    cpu: 300m
                    memory: 1Gi
                  requests:
                    cpu: 200m
                    memory: 500Mi
                postgresql:
                  shared_preload_libraries:
                    - timescaledb
                postgresUID: 70 # see below
                postgresGID: 70 # see below
                bootstrap:
                  initdb:
                    postInitTemplateSQL:
                      - CREATE EXTENSION timescaledb VERSION '2.19.3';
                      - CREATE EXTENSION IF NOT EXISTS timescaledb;
                      - CREATE EXTENSION IF NOT EXISTS timescaledb_toolkit;
    destination:
      namespace: converse-lightbridge
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true

  - name: converse-mongo-backup
    finalizers:
      - resources-finalizer.argocd.argoproj.io
    source:
      repoURL: https://github.com/ADORSYS-GIS/ai-helm
      targetRevision: feat/mongodb-backup
      path: charts/mongodb-backup
      helm:
        releaseName: mongodb-backup
        valuesObject: 
          mongo-backup:
            controllers:
              main:
                cronjob:
                  # Runs every day at 23:59
                  schedule: "59 23 * * *"
                initContainers:
                  exporter:
                    env:
                      MONGODB_URI: "mongodb://converse-db-0.converse-db-headless:27017"
    destination:
      namespace: converse-chat
    syncPolicy:
      syncOptions:
        - ServerSideApply=true
      automated:
        prune: true
        selfHeal: true
